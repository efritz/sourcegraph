digraph architecture {
    label="Sourcegraph Architecture Overview\n\nBox => horizontally scalable service, Rectangle => singleton service"
    rankdir=LR
    ratio=fill
    ranksep=1.2
    nodesep=0.4
    compound=true
    stylesheet="/assets/architecture.css"

    graph [
        fontname="Iosevka"
        fontsize=12
        pad=0.2
    ]

    node [
        colorscheme="set312"
        style="filled"
        fillcolor="white"
        shape="rectangle"
        fontname="Iosevka"
        fontsize=10
        margin=0.15
        target="_blank"
    ]

    edge [
        colorscheme="set312"
        penwidth=0.6
        arrowtail=invis
        arrowsize=1.35
    ]

    subgraph cluster_clients {
        label="Clients"
        graph [style="dotted"]
        node [
            shape="circle"
            fixedsize="true"
            width="1"
            fillcolor="#fff0d0"
        ]

        web_app [label="Web App\n(SPA)" URL="https://github.com/sourcegraph/sourcegraph/tree/main/client/web"]
        browser_ext [label="Browser\nExtensions" URL="https://github.com/sourcegraph/sourcegraph/tree/main/client/browser/"]
        src_cli [label="src-cli" URL="https://github.com/sourcegraph/src-cli"]
        native_integrations [label="Native\nIntegrations"]
        editor_ext [label="Editor\nExtensions"]
        customer_scripts [label="Customer\nScripts"]
    }

    subgraph cluster_services {
        label="Services"
        graph [style="dotted"]

    syntect_server [
        label="syntect\nserver"
        URL="https://github.com/sourcegraph/syntect_server"
    ]

        frontend [
            fixedsize=true
            width=1.2
            height=1.2
            shape="box3d"
            label="frontend"
            fillcolor="1"
            URL="https://github.com/sourcegraph/sourcegraph/tree/master/cmd/frontend"
        ]

        subgraph cluster_search {
            label="Search"
            graph [style="dotted"]
            node [fillcolor="10"]

            searcher [
                label="searcher"
                fillcolor="4"
                shape="box3d"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/cmd/searcher"
            ]
            symbols [
                label="symbols"
                fillcolor="8"
                shape="box3d"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/cmd/symbols"
            ]
            query_runner [
                label="query\nrunner"
                fillcolor="6"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/cmd/query-runner"
            ]

            subgraph cluster_zoekt {
                label="Indexed search"
                graph [style="dotted"]
                node [fillcolor="10"]

                zoekt_webserver [
                    label="zoekt\nwebserver"
                    URL="https://github.com/sourcegraph/zoekt/tree/master/cmd/zoekt-webserver"
                ]
                zoekt_indexserver [
                    label="zoekt\nindexserver"
                    shape="box3d"
                    URL="https://github.com/sourcegraph/zoekt/tree/master/cmd/zoekt-sourcegraph-indexserver"
                ]
            }
        }

        subgraph cluster_core_services {
            label="Core services"
            graph [style="dotted"]

            gitserver [
                label="gitserver"
                fillcolor="2"
                shape="box3d"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/cmd/gitserver"
            ]

            repo_updater [
                label="repo\nupdater"
                fillcolor="3"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/cmd/repo-updater"
            ]
        }


        subgraph cluster_precise_code_intel {
            label="Precise code intelligence"
            graph [style="dotted"]
            node [fillcolor="9"]

            bundle_manager [
                label="bundle manager"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/enterprise/cmd/precise-code-intel-bundle-manager"
            ]
            worker [
                label="worker"
                shape="box3d"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/enterprise/cmd/precise-code-intel-worker"
            ]
            indexer [
                label="indexer"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/enterprise/cmd/precise-code-intel-indexer"
            ]
            indexer_vm [
                label="indexer vm"
                shape="box3d"
                URL="https://github.com/sourcegraph/sourcegraph/tree/master/enterprise/cmd/precise-code-intel-indexer-vm"
            ]
        }

        github_proxy [
            label="github\nproxy"
            fillcolor="7"
            URL="https://github.com/sourcegraph/sourcegraph/tree/master/cmd/github-proxy"
        ]

        subgraph cluster_databases {
            label="PostgreSQL"
            graph [style="dotted"]
            node [shape="cylinder"]

            postgres [label="frontend db"]
            codeintel_db [label="codeintel db"]
        }

        subgraph cluster_caches {
            label="Caches"
            graph [style="dotted"]
            node [shape="cylinder"]

            redis_cache [label="redis cache"]
            redis_store [label="redis store"]
        }
    }

    subgraph cluster_codehosts {
        label="Code hosts"
        graph [style="dotted"]
        node  [
            shape="circle"
            fixedsize="true"
            width="1"
            fillcolor="#fff0d0"
        ]

        github_dot_com [label="github.com"]
        gitlab_dot_com [label="gitlab.com"]
        bitbucket_cloud [label="bitbucket.org"]
        github_enterprise [label="GitHub\nEnterprise"]
        bitbucket_server [label="Bitbucket\nServer"]
    }

    browser_ext -> frontend[ltail=cluster_clients, fillcolor="#fff0d0"]
    frontend -> {postgres} [lhead=cluster_databases, fillcolor="1"]
    frontend -> {searcher, symbols, query_runner, bundle_manager, indexer, gitserver, repo_updater, zoekt_webserver, syntect_server} [fillcolor="1"]
    frontend -> {redis_cache} [lhead=cluster_caches, fillcolor="1"]
    searcher -> gitserver [fillcolor="4"]
    symbols -> gitserver [fillcolor="8"]
    zoekt_indexserver -> {frontend, gitserver} [fillcolor="10"]
    bundle_manager -> {postgres} [lhead=cluster_databases, fillcolor="9"]
    worker -> {postgres} [lhead=cluster_databases, fillcolor="9"]
    worker -> {bundle_manager} [fillcolor="9"]
    indexer -> postgres [fillcolor="9"]
    indexer_vm -> frontend [fillcolor="9"]
    gitserver -> {github_proxy} [fillcolor="2"]
    gitserver -> {bitbucket_cloud} [lhead=cluster_codehosts, fillcolor="#fff0d0"]
    repo_updater -> {postgres, github_proxy} [fillcolor="3"]
    repo_updater -> {bitbucket_cloud} [lhead=cluster_codehosts, fillcolor="#fff0d0"]
    github_proxy -> github_dot_com [fillcolor="7"]

    /* Layout hints */
    edge[style="invis"] indexer_vm -> indexer
}
